<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Videos SN</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0A246A">
    <meta name="description" content="Generador de videos para Instagram con marca de agua SN">
    
    <!-- iOS Safari PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Videos SN">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="http://kumodev.com/sn/snlogo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="http://kumodev.com/sn/snlogo.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest-video.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Montserrat:ital,wght@0,400;0,900;1,400;1,700;1,900&display=swap" rel="stylesheet">

    <!-- ffmpeg.wasm -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
        }
        .main-container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .controls { 
            background-color: #ffffff; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto;
        }
        .controls h1 {
            margin-top: 0;
            color: #333;
            text-align: center;
        }
        
        .logo-sn-container { 
            font-family: 'Montserrat', sans-serif; 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin-bottom: 20px; 
            align-self: center; 
        }
        .logo-sn-text { 
            font-weight: 900; 
            font-size: 72px; 
            line-height: 0.7; 
            margin-bottom: 0; 
        }
        .logo-sn-text .letter { 
            font-style: italic; 
        }
        .logo-sn-text .letter-s { 
            color: #b42727; 
        }
        .logo-sn-text .letter-n { 
            color: #2a2972; 
            margin-left: -0.15em; 
        }
        .logo-sn-url { 
            font-weight: 700; 
            font-style: italic; 
            font-size: 16px; 
            color: #000000; 
            letter-spacing: -0.025em; 
        }
        .logo-sn-container { 
            font-family: 'Montserrat', sans-serif; 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin-bottom: 20px; 
            align-self: center; 
            width: 100%;
        }
        .logo-sn-text { 
            font-weight: 900; 
            font-size: 72px; 
            line-height: 0.7; 
            margin-bottom: 0; 
        }
        .logo-sn-text .letter { 
            font-style: italic; 
        }
        .logo-sn-text .letter-s { 
            color: #b42727; 
        }
        .logo-sn-text .letter-n { 
            color: #2a2972; 
            margin-left: -0.15em; 
        }
        .logo-sn-url { 
            font-weight: 700; 
            font-style: italic; 
            font-size: 16px; 
            color: #000000; 
            letter-spacing: -0.025em; 
        }
        .controls label { 
            display: block; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #555; 
        }
        .controls input[type="file"], 
        .controls input[type="text"], 
        .controls textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        .controls button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 20px; 
            background-color: #D32F2F; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .controls button:hover { 
            background-color: #B71C1C; 
        }
        .controls button:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-radius: 50%; 
            border-top: 4px solid #3498db; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            display: none; 
            margin: 20px auto; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .preview-container { 
            margin-top: 30px; 
            text-align: center; 
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 300px;
            border: 2px dashed #ddd;
        }
        .preview-container h3 {
            color: #333;
            margin-bottom: 15px;
        }
        #videoPreview, #canvasPreview { 
            max-width: 100%; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        #canvasPreview { 
            display: none; 
        }
        #videoPreviewWrapper {
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .status { 
            margin-top: 15px; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: center; 
        }
        .status.info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
        }
        .status.success { 
            background-color: #d4edda; 
            color: #155724; 
        }
        .status.error { 
            background-color: #f8d7da; 
            color: #721c24; 
        }
        .progress-bar { 
            width: 100%; 
            height: 30px; 
            background-color: #e0e0e0; 
            border-radius: 15px; 
            overflow: hidden; 
            margin-top: 10px; 
            display: none; 
        }
        .progress-fill { 
            height: 100%; 
            background-color: #28a745; 
            width: 0%; 
            transition: width 0.3s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
        }
        .watermark-preview { 
            position: relative; 
            display: inline-block; 
            margin-top: 20px; 
        }
        .watermark-overlay { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            font-family: 'Montserrat', sans-serif; 
            font-weight: 900; 
            font-style: italic; 
            font-size: 48px; 
            color: white; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); 
            pointer-events: none; 
        }
        .watermark-overlay .letter-s { 
            color: #b42727; 
        }
        .watermark-overlay .letter-n { 
            color: #2a2972; 
        }
        #playButton:hover {
            background: rgba(0,0,0,0.9);
            transform: translate(-50%, -50%) scale(1.1);
            transition: all 0.2s;
        }
        #videoThumbnail:hover {
            opacity: 0.9;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="controls">
            <div class="logo-sn-container">
                <div class="logo-sn-text">
                    <span class="letter letter-s">S</span><span class="letter letter-n">N</span>
                </div>
                <div class="logo-sn-url">saltanews.com.ar</div>
            </div>
            <h1>Generador de Videos SN</h1>
            
            <label>URL del Video de Instagram:</label>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="text" id="video-url-input" placeholder="Pega la URL del video de Instagram..." style="flex: 1;">
                <button id="paste-url-btn" style="margin-top: 0; width: auto; padding: 10px 15px; background-color: #28a745;">üìã Pegar</button>
                <button id="fetch-video-btn" style="margin-top: 0; width: auto; padding: 10px 20px;">Descargar y Cargar</button>
            </div>
            <div id="video-url-status" style="font-size: 0.9em; color: #0A246A; margin-top: 8px; min-height: 1.5em; padding: 8px; background-color: #e3f2fd; border-radius: 4px; border-left: 3px solid #0A246A; font-weight: 500; display: block;">‚úÖ Sistema listo - Pega la URL del reel y haz clic en "Descargar y Cargar"</div>
            
            <label>O sube un video:</label>
            <input type="file" id="video-input" accept="video/*">
            
            <div style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px;">
                <h3 style="margin-top: 0;">Configuraci√≥n de la Portada</h3>
                
                <label>Frame para la portada (segundos):</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="range" id="frame-selector" min="0" max="10" step="0.1" value="0.5" style="flex: 1;">
                    <span id="frame-time" style="min-width: 50px; font-weight: bold;">0.5s</span>
                </div>
                <small style="color: #666;">Desliz√° para elegir el frame que quieras en la portada</small>
                
                <label style="margin-top: 15px;">Posici√≥n de la imagen (%):</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.9em; color: #666;">Posici√≥n X:</label>
                        <input type="range" id="image-x-position" min="-50" max="50" step="1" value="0" style="width: 100%;">
                        <span id="image-x-value" style="font-size: 0.85em; font-weight: bold;">0%</span>
                    </div>
                    <div>
                        <label style="font-size: 0.9em; color: #666;">Posici√≥n Y:</label>
                        <input type="range" id="image-y-position" min="-50" max="50" step="1" value="0" style="width: 100%;">
                        <span id="image-y-value" style="font-size: 0.85em; font-weight: bold;">0%</span>
                    </div>
                </div>
                
                <label style="margin-top: 15px;">Zoom de la imagen:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="range" id="image-zoom" min="50" max="200" step="5" value="100" style="flex: 1;">
                    <span id="image-zoom-value" style="min-width: 50px; font-weight: bold;">100%</span>
                </div>
                
                <label style="margin-top: 15px;">Fondo (cuando imagen no llena el √°rea):</label>
                <select id="image-effect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="cover">Llenar √°rea completa (crop)</option>
                    <option value="gradient">Degradado azul SN</option>
                    <option value="blur">Imagen desenfocada</option>
                </select>
                
                <label style="margin-top: 15px;">T√≠tulo para la portada:</label>
                <input type="text" id="title-input" placeholder="Escribe el t√≠tulo o genera con IA abajo...">
                
                <h3 style="margin-top: 20px;">Generar T√≠tulo y Texto con IA</h3>
                
                <label>Descripci√≥n del video (se autocompleta desde Instagram):</label>
                <textarea id="video-description-input" rows="3" placeholder="Se llenar√° autom√°ticamente con la descripci√≥n de Instagram..."></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="generate-text-btn" style="background-color: #0A246A; flex: 1;">‚ú® Generar T√≠tulo y Texto</button>
                    <button id="regenerate-text-btn" style="background-color: #28a745; flex: 1; display: none;">üîÑ Regenerar</button>
                </div>
                <div id="description-status" style="font-size: 0.85em; color: #666; margin-top: 8px; padding: 8px; background-color: #f0f0f0; border-radius: 4px; display: none;"></div>
                
                <label style="margin-top: 15px;">Texto para compartir (se copiar√° autom√°ticamente):</label>
                <textarea id="text-output" rows="6" placeholder="El texto generado aparecer√° aqu√≠..."></textarea>
                <button id="copy-text-btn" style="background-color: #6c757d; margin-top: 5px; display: none;">Copiar Texto</button>
            </div>
            
            <div class="loader" id="loader"></div>
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill">0%</div>
            </div>
            
            <div id="status" class="status info" style="display: none;"></div>
            
            <button id="process-btn" disabled>üì± Procesar y Compartir en Instagram</button>
            <button id="download-original-btn" disabled style="background-color: #ff9800; margin-top: 10px;">üì• Descargar Video Original</button>
            <button id="download-btn" disabled style="background-color: #28a745; display: none;">üíæ Descargar Video Procesado</button>
            
            <div class="preview-container">
                <h3 style="margin-top: 0; margin-bottom: 15px; color: #333;">Preview del Video</h3>
                <div id="videoPreviewWrapper" style="position: relative; display: none; max-width: 100%; margin: 0 auto;">
                    <img id="videoThumbnail" style="width: 100%; max-width: 600px; border-radius: 8px; cursor: pointer; display: block; margin: 0 auto;">
                    <video id="videoPreview" controls style="display: none; width: 100%; max-width: 600px; border-radius: 8px; margin: 0 auto;"></video>
                    <div id="playButton" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; z-index: 10;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                </div>
                <canvas id="canvasPreview" style="display: none;"></canvas>
                <p id="preview-placeholder" style="color: #999; text-align: center; padding: 40px 0;">El preview del video aparecer√° aqu√≠ despu√©s de cargarlo</p>
            </div>
        </div>
    </div>

    <script>
        // Verificar si FFmpeg est√° disponible
        const { createFFmpeg, fetchFile } = FFmpeg || {};
        console.log('‚úÖ FFmpeg cargado:', {createFFmpeg: !!createFFmpeg, fetchFile: !!fetchFile});
        
        if (!createFFmpeg || !fetchFile) {
            console.error('‚ùå FFmpeg no disponible. Verifica que se carg√≥ correctamente.');
        }
        
        let ffmpeg = null;
        let videoFile = null;
        let processedVideoBlob = null;

        // API Key de Gemini (misma que en gensn.html)
        const GEMINI_API_KEY = 'AIzaSyBim_waPtFzRlLFgOeDd9_gyWhNzM6Euqw';
        // Groq (opcional): si pon√©s tu clave, cuando Gemini llega al l√≠mite usa Groq
        const GROQ_API_KEY = '';
        
        // Base URL del backend (app Android / PWA: poner la URL de tu servidor desplegado)
        function getApiBase() {
            const base = (window.SN_API_BASE || localStorage.getItem('SN_API_BASE') || '').trim().replace(/\/$/, '');
            return base || null;
        }
        
        console.log('üöÄ Script iniciado');

        const els = {
            videoUrlInput: document.getElementById('video-url-input'),
            pasteUrlBtn: document.getElementById('paste-url-btn'),
            fetchVideoBtn: document.getElementById('fetch-video-btn'),
            videoUrlStatus: document.getElementById('video-url-status'),
            videoInput: document.getElementById('video-input'),
            videoDescriptionInput: document.getElementById('video-description-input'),
            generateTextBtn: document.getElementById('generate-text-btn'),
            regenerateTextBtn: document.getElementById('regenerate-text-btn'),
            descriptionStatus: document.getElementById('description-status'),
            frameSelector: document.getElementById('frame-selector'),
            frameTime: document.getElementById('frame-time'),
            imageXPosition: document.getElementById('image-x-position'),
            imageXValue: document.getElementById('image-x-value'),
            imageYPosition: document.getElementById('image-y-position'),
            imageYValue: document.getElementById('image-y-value'),
            imageZoom: document.getElementById('image-zoom'),
            imageZoomValue: document.getElementById('image-zoom-value'),
            imageEffect: document.getElementById('image-effect'),
            titleInput: document.getElementById('title-input'),
            textOutput: document.getElementById('text-output'),
            copyTextBtn: document.getElementById('copy-text-btn'),
            processBtn: document.getElementById('process-btn'),
            downloadOriginalBtn: document.getElementById('download-original-btn'),
            downloadBtn: document.getElementById('download-btn'),
            loader: document.getElementById('loader'),
            progressBar: document.getElementById('progress-bar'),
            progressFill: document.getElementById('progress-fill'),
            status: document.getElementById('status'),
            videoPreviewWrapper: document.getElementById('videoPreviewWrapper'),
            videoThumbnail: document.getElementById('videoThumbnail'),
            videoPreview: document.getElementById('videoPreview'),
            playButton: document.getElementById('playButton'),
            canvasPreview: document.getElementById('canvasPreview')
        };

        // Verificar que todos los elementos existan
        console.log('üîç Elementos encontrados:', {
            fetchVideoBtn: !!els.fetchVideoBtn,
            videoUrlInput: !!els.videoUrlInput,
            videoUrlStatus: !!els.videoUrlStatus,
            status: !!els.status
        });

        if (!els.fetchVideoBtn) {
            console.error('‚ùå No se encontr√≥ el bot√≥n fetch-video-btn');
        }
        if (!els.videoUrlInput) {
            console.error('‚ùå No se encontr√≥ el input video-url-input');
        }
        if (!els.videoUrlStatus) {
            console.error('‚ùå No se encontr√≥ el elemento video-url-status');
        }

        // Funci√≥n para mostrar preview del video con primer frame
        function showVideoPreview(videoFile) {
            console.log('üé¨ Mostrando preview del video:', videoFile.name || 'video');
            
            try {
                const videoUrl = URL.createObjectURL(videoFile);
                const tempVideo = document.createElement('video');
                tempVideo.src = videoUrl;
                tempVideo.muted = true;
                tempVideo.preload = 'metadata';
                
                tempVideo.onloadedmetadata = () => {
                    console.log('‚úÖ Metadata cargada, dimensiones:', tempVideo.videoWidth, 'x', tempVideo.videoHeight);
                    console.log('‚úÖ Duraci√≥n del video:', tempVideo.duration, 'segundos');
                    
                    // Actualizar slider de frame seg√∫n duraci√≥n del video
                    if (els.frameSelector) {
                        const videoDuration = tempVideo.duration || 10;
                        const maxTime = Math.min(videoDuration - 0.5, 30); // M√°ximo 30 segundos o duraci√≥n del video
                        els.frameSelector.max = maxTime > 0 ? maxTime : 10;
                        els.frameSelector.value = 0.5;
                        if (els.frameTime) els.frameTime.textContent = '0.5s';
                        console.log('üé¨ Frame selector configurado: 0 - ' + maxTime.toFixed(1) + 's');
                    }
                    
                    // Usar el frame seleccionado
                    const selectedTime = els.frameSelector ? parseFloat(els.frameSelector.value) : 0.5;
                    tempVideo.currentTime = selectedTime;
                };
                
                tempVideo.onerror = (e) => {
                    console.error('‚ùå Error cargando video:', e);
                    els.videoUrlStatus.textContent = '‚ùå Error al cargar el video';
                    els.videoUrlStatus.style.color = '#D32F2F';
                };
                
                tempVideo.onseeked = async () => {
                    try {
                        console.log('‚úÖ Frame encontrado, creando portada azul...');
                        
                        // Crear portada azul (estilo placa) en vez del primer frame
                        const coverCanvas = await createCoverFrame(tempVideo);
                        
                        // Mostrar portada como thumbnail
                        els.videoThumbnail.src = coverCanvas.toDataURL();
                        els.videoPreview.src = videoUrl;
                        els.videoPreviewWrapper.style.display = 'block';
                        els.canvasPreview.style.display = 'none';
                        
                        // Ocultar placeholder
                        const placeholder = document.getElementById('preview-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                        
                        console.log('‚úÖ Preview con portada azul mostrado correctamente');
                        
                        // Mostrar video cuando se hace clic en play
                        els.playButton.onclick = () => {
                            els.videoThumbnail.style.display = 'none';
                            els.playButton.style.display = 'none';
                            els.videoPreview.style.display = 'block';
                            els.videoPreview.play();
                        };
                        
                        els.videoThumbnail.onclick = () => {
                            els.videoThumbnail.style.display = 'none';
                            els.playButton.style.display = 'none';
                            els.videoPreview.style.display = 'block';
                            els.videoPreview.play();
                        };
                    } catch (error) {
                        console.error('‚ùå Error creando portada:', error);
                        // Fallback: mostrar video directamente sin thumbnail
                        els.videoPreview.src = videoUrl;
                        els.videoPreview.style.display = 'block';
                        els.videoPreviewWrapper.style.display = 'block';
                        els.playButton.style.display = 'none';
                        els.videoThumbnail.style.display = 'none';
                    }
                };
                
                // Si no se puede hacer seek, mostrar video directamente
                setTimeout(() => {
                    if (!els.videoThumbnail.src) {
                        console.log('‚ö†Ô∏è Timeout, mostrando video directamente');
                        els.videoPreview.src = videoUrl;
                        els.videoPreview.style.display = 'block';
                        els.videoPreviewWrapper.style.display = 'block';
                        els.playButton.style.display = 'none';
                        els.videoThumbnail.style.display = 'none';
                        const placeholder = document.getElementById('preview-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                    }
                }, 3000);
            } catch (error) {
                console.error('‚ùå Error en showVideoPreview:', error);
                els.videoUrlStatus.textContent = '‚ùå Error al mostrar preview: ' + error.message;
                els.videoUrlStatus.style.color = '#D32F2F';
            }
        }

        // Inicializar FFmpeg
        async function initFFmpeg() {
            // Si ya est√° cargado, no hacer nada
            if (ffmpeg && ffmpeg.isLoaded()) {
                console.log('‚úÖ FFmpeg ya est√° cargado');
                return;
            }
            
            if (!createFFmpeg || !fetchFile) {
                console.error('‚ùå FFmpeg no disponible, no se puede procesar video');
                throw new Error('FFmpeg no est√° disponible en este navegador');
            }
            
            els.status.style.display = 'block';
            els.status.className = 'status info';
            els.status.textContent = '‚è≥ Inicializando procesador de video...';
            
            // Crear instancia si no existe
            if (!ffmpeg) {
                ffmpeg = createFFmpeg({
                    log: true,
                    progress: ({ ratio }) => {
                        const percent = Math.round(ratio * 100);
                        els.progressFill.style.width = percent + '%';
                        els.progressFill.textContent = percent + '%';
                    }
                });
            }
            
            try {
                await ffmpeg.load();
                console.log('‚úÖ FFmpeg cargado exitosamente');
                els.status.textContent = '‚úÖ Procesador listo';
                setTimeout(() => {
                    els.status.style.display = 'none';
                }, 2000);
            } catch (error) {
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Error al inicializar: ' + error.message;
                console.error('FFmpeg init error:', error);
                throw error;
            }
        }

        // Bot√≥n para pegar URL del portapapeles
        if (els.pasteUrlBtn) {
            els.pasteUrlBtn.addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        els.videoUrlInput.value = text;
                        els.pasteUrlBtn.textContent = '‚úì Pegado';
                        els.pasteUrlBtn.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            els.pasteUrlBtn.textContent = 'üìã Pegar';
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Error pegando del portapapeles:', err);
                    els.pasteUrlBtn.textContent = '‚ùå Error';
                    els.pasteUrlBtn.style.backgroundColor = '#dc3545';
                    setTimeout(() => {
                        els.pasteUrlBtn.textContent = 'üìã Pegar';
                        els.pasteUrlBtn.style.backgroundColor = '#28a745';
                    }, 2000);
                }
            });
        }

        // Descargar y cargar video desde Instagram
        if (els.fetchVideoBtn) {
            els.fetchVideoBtn.addEventListener('click', async () => {
                console.log('üîµ Bot√≥n clickeado');
                
                const url = els.videoUrlInput.value.trim();
                console.log('üîµ URL ingresada:', url);
                
                if (!url) {
                    els.videoUrlStatus.textContent = '‚ùå Por favor, ingresa una URL de Instagram';
                    els.videoUrlStatus.style.color = '#D32F2F';
                    els.videoUrlStatus.style.borderLeftColor = '#D32F2F';
                    els.videoUrlStatus.style.backgroundColor = '#f8d7da';
                    return;
                }

                // Verificar que sea URL de Instagram (posts, reels, videos)
                if (!url.includes('instagram.com')) {
                    els.videoUrlStatus.textContent = '‚ö†Ô∏è Por favor, ingresa una URL de Instagram';
                    els.videoUrlStatus.style.color = '#ff9800';
                    els.videoUrlStatus.style.borderLeftColor = '#ff9800';
                    els.videoUrlStatus.style.backgroundColor = '#fff3cd';
                    return;
                }
                
                console.log('üîµ URL v√°lida, iniciando descarga...');

            console.log('üîµ Iniciando descarga...');
            
            els.fetchVideoBtn.disabled = true;
            els.videoUrlStatus.textContent = '‚è≥ Descargando video de Instagram...';
            els.videoUrlStatus.style.color = '#0A246A';
            els.videoUrlStatus.style.borderLeftColor = '#0A246A';
            els.videoUrlStatus.style.backgroundColor = '#e3f2fd';
            els.videoUrlStatus.style.display = 'block'; // Asegurar que sea visible
            els.loader.style.display = 'block';
            
            // Mostrar tambi√©n en status principal
            if (els.status) {
                els.status.style.display = 'block';
                els.status.className = 'status info';
                els.status.textContent = '‚è≥ Descargando video de Instagram...';
            }
            
            console.log('üîµ Status actualizado, iniciando servicios...');

            try {
                console.log('üîµ Extrayendo shortcode de:', url);
                
                // Extraer c√≥digo corto de Instagram (soporta posts, reels, videos)
                // Patrones: instagram.com/p/ABC123, instagram.com/reel/ABC123, instagram.com/reels/ABC123, instagram.com/tv/ABC123
                let shortcodeMatch = url.match(/instagram\.com\/(?:p|reel|reels|tv)\/([A-Za-z0-9_-]+)/);
                
                // Si no coincide, intentar sin www
                if (!shortcodeMatch) {
                    shortcodeMatch = url.match(/instagram\.com\/(?:p|reel|reels|tv)\/([A-Za-z0-9_-]+)/);
                }
                
                if (!shortcodeMatch) {
                    console.error('‚ùå No se pudo extraer shortcode de:', url);
                    els.videoUrlStatus.textContent = '‚ùå URL no v√°lida. Debe ser un post o reel de Instagram. Ejemplo: https://www.instagram.com/reel/ABC123/';
                    els.videoUrlStatus.style.color = '#D32F2F';
                    els.videoUrlStatus.style.borderLeftColor = '#D32F2F';
                    els.videoUrlStatus.style.backgroundColor = '#f8d7da';
                    throw new Error('URL de Instagram no v√°lida. Debe ser un post, reel o video.');
                }
                const shortcode = shortcodeMatch[1];
                console.log('‚úÖ Shortcode extra√≠do:', shortcode);

                // Usar m√∫ltiples servicios para descargar videos de Instagram
                let videoUrl = null;
                let lastError = null;

                // USAR NUESTRO PROXY PHP (evita CORS completamente)
                try {
                    els.videoUrlStatus.textContent = '‚è≥ Descargando video desde servidor...';
                    els.videoUrlStatus.style.color = '#0A246A';
                    els.videoUrlStatus.style.borderLeftColor = '#0A246A';
                    els.videoUrlStatus.style.backgroundColor = '#e3f2fd';
                    els.status.textContent = '‚è≥ Descargando video de Instagram...';
                    els.status.className = 'status info';
                    
                    console.log('üåê Descargando video de Instagram...');
                    
                    // Detectar entorno
                    const hostname = window.location.hostname;
                    const port = window.location.port;
                    const apiBase = getApiBase();
                    
                    // Si la app (Android/PWA) defini√≥ API base, usarla para todo
                    let proxyUrl;
                    if (apiBase) {
                        proxyUrl = `${apiBase}/api/download?url=${encodeURIComponent(url)}`;
                    } else {
                        const isLocal = hostname === 'localhost' || 
                                       hostname === '127.0.0.1' || 
                                       hostname.startsWith('192.168.') || 
                                       hostname.startsWith('10.') ||
                                       hostname.startsWith('172.') ||
                                       port === '8000';
                        const isRender = hostname.includes('onrender.com');
                        if (isLocal) {
                            proxyUrl = `http://${hostname}:8000/api/download?url=${encodeURIComponent(url)}`;
                        } else if (isRender) {
                            proxyUrl = `/api/download?url=${encodeURIComponent(url)}`;
                        } else {
                            proxyUrl = `./instagram-proxy.php?url=${encodeURIComponent(url)}`;
                        }
                    }
                    
                    const entorno = apiBase ? 'APP/REMOTO' : (hostname === 'localhost' || hostname.startsWith('192.168.') ? 'LOCAL' : hostname.includes('onrender.com') ? 'RENDER' : 'HOSTING PHP');
                    console.log('üìç Entorno:', entorno);
                    console.log('üìç URL del proxy:', proxyUrl);
                    
                    console.log('üîÑ Haciendo fetch a:', proxyUrl);
                    els.videoUrlStatus.textContent = 'üîÑ Conectando: ' + proxyUrl.substring(0, 50) + '...';
                    
                    const proxyResponse = await fetch(proxyUrl);
                    console.log('üì• Proxy Response status:', proxyResponse.status, proxyResponse.statusText);
                    els.videoUrlStatus.textContent = 'üì• Respuesta del servidor: ' + proxyResponse.status;
                    
                    if (proxyResponse.ok) {
                        els.videoUrlStatus.textContent = 'üìÑ Leyendo respuesta...';
                        const responseText = await proxyResponse.text();
                        console.log('üìÑ Proxy Response raw:', responseText.substring(0, 200));
                        
                        let proxyData;
                        try {
                            proxyData = JSON.parse(responseText);
                            els.videoUrlStatus.textContent = '‚úÖ Datos recibidos correctamente';
                        } catch (e) {
                            console.error('‚ùå Error parseando JSON:', e);
                            els.videoUrlStatus.textContent = '‚ùå Error: Respuesta inv√°lida del servidor';
                            throw new Error('Respuesta inv√°lida del servidor: ' + responseText.substring(0, 100));
                        }
                        
                        console.log('‚úÖ Proxy Response parsed:', proxyData);
                        
                        if (proxyData.success) {
                            // Caso 1: Video como URL (m√©todos normales)
                            if (proxyData.video_url) {
                                videoUrl = proxyData.video_url;
                                els.videoUrlStatus.textContent = `‚úÖ Video descargado (m√©todo: ${proxyData.method})`;
                                els.videoUrlStatus.style.color = '#28a745';
                                els.videoUrlStatus.style.borderLeftColor = '#28a745';
                                els.videoUrlStatus.style.backgroundColor = '#d4edda';
                                els.status.textContent = '‚úÖ Video encontrado';
                                els.status.className = 'status success';
                                console.log('‚úÖ Video URL:', videoUrl);
                            }
                            // Caso 2: Video como base64 (yt-dlp)
                            else if (proxyData.video_data) {
                                els.videoUrlStatus.textContent = `‚úÖ Video descargado con yt-dlp (${(proxyData.size / 1024 / 1024).toFixed(2)} MB)`;
                                els.videoUrlStatus.style.color = '#28a745';
                                els.videoUrlStatus.style.borderLeftColor = '#28a745';
                                els.videoUrlStatus.style.backgroundColor = '#d4edda';
                                
                                // Convertir base64 a blob
                                const binaryData = atob(proxyData.video_data);
                                const bytes = new Uint8Array(binaryData.length);
                                for (let i = 0; i < binaryData.length; i++) {
                                    bytes[i] = binaryData.charCodeAt(i);
                                }
                                const blob = new Blob([bytes], { type: 'video/mp4' });
                                videoFile = new File([blob], `instagram-${shortcode}.mp4`, { type: 'video/mp4' });
                                
                                // Mostrar preview
                                showVideoPreview(videoFile);
                                els.processBtn.disabled = false;
                                els.downloadOriginalBtn.disabled = false;
                                
                                // Extraer descripci√≥n de Instagram si viene en los metadatos
                                if (proxyData.description && proxyData.description.trim()) {
                                    console.log('üìù Descripci√≥n de Instagram:', proxyData.description);
                                    els.videoDescriptionInput.value = proxyData.description;
                                    
                                    // Mostrar mensaje de que se extrajo la descripci√≥n
                                    els.descriptionStatus.style.display = 'block';
                                    els.descriptionStatus.style.backgroundColor = '#d4edda';
                                    els.descriptionStatus.style.color = '#155724';
                                    els.descriptionStatus.style.borderLeft = '3px solid #28a745';
                                    els.descriptionStatus.textContent = '‚úÖ Descripci√≥n extra√≠da del post de Instagram';
                                    
                                    console.log('‚úÖ Descripci√≥n del post cargada autom√°ticamente');
                                } else {
                                    console.log('‚ÑπÔ∏è No hay descripci√≥n en el post de Instagram');
                                    
                                    // Mostrar mensaje de que no hay descripci√≥n
                                    els.descriptionStatus.style.display = 'block';
                                    els.descriptionStatus.style.backgroundColor = '#fff3cd';
                                    els.descriptionStatus.style.color = '#856404';
                                    els.descriptionStatus.style.borderLeft = '3px solid #ffc107';
                                    els.descriptionStatus.textContent = '‚ÑπÔ∏è Este post no tiene descripci√≥n. Escribe una para generar t√≠tulo y texto.';
                                }
                                
                                els.videoUrlStatus.textContent = '‚úÖ Video descargado y listo';
                                els.videoUrlStatus.style.color = '#28a745';
                                els.videoUrlStatus.style.borderLeftColor = '#28a745';
                                els.videoUrlStatus.style.backgroundColor = '#d4edda';
                                
                                els.status.textContent = '‚úÖ Video listo';
                                els.status.className = 'status success';
                                console.log('‚úÖ Video descargado con yt-dlp');
                                
                // NO inicializar FFmpeg aqu√≠, solo cuando se vaya a procesar
                // await initFFmpeg();
                
                // Auto-generar t√≠tulo y texto basado en la descripci√≥n de Instagram
                if (proxyData.description && proxyData.description.trim()) {
                    els.status.textContent = '‚è≥ Generando t√≠tulo y texto con IA...';
                    els.status.className = 'status info';
                    await autoGenerateContent();
                    els.regenerateTextBtn.style.display = 'block';
                } else {
                    els.status.textContent = '‚úÖ Video listo. Escribe una descripci√≥n para generar t√≠tulo y texto.';
                }
                                
                                els.fetchVideoBtn.disabled = false;
                                els.loader.style.display = 'none';
                                return; // Salir aqu√≠ porque ya tenemos el video
                            }
                        } else if (proxyData.error) {
                            lastError = `Proxy: ${proxyData.error}`;
                            console.log('‚ùå Proxy error:', proxyData.error);
                            
                            // Mostrar errores de debug si existen
                            if (proxyData.debug && proxyData.debug.length > 0) {
                                console.log('üîç Errores detallados:');
                                proxyData.debug.forEach((err, i) => {
                                    console.log(`  ${i + 1}. ${err}`);
                                });
                            }
                        } else {
                            lastError = 'Proxy: No se encontr√≥ video en la respuesta';
                            console.log('‚ùå Proxy respuesta sin video:', proxyData);
                        }
                    } else {
                        const errorText = await proxyResponse.text();
                        try {
                            const errJson = JSON.parse(errorText);
                            lastError = errJson.error || `Error ${proxyResponse.status}`;
                            if (errJson.debug) lastError += ' (' + (typeof errJson.debug === 'string' ? errJson.debug.substring(0, 80) : String(errJson.debug).substring(0, 80)) + ')';
                        } catch (_) {
                            lastError = `Proxy: Error ${proxyResponse.status}`;
                        }
                        console.log('‚ùå Proxy HTTP error:', proxyResponse.status, errorText.substring(0, 200));
                    }
                } catch (e) {
                    lastError = `Proxy: ${e.message}`;
                    console.log('‚ùå Proxy fall√≥:', e);
                }
                
                if (!videoUrl && lastError) {
                    els.videoUrlStatus.textContent = '‚ùå ' + lastError;
                    els.videoUrlStatus.style.color = '#D32F2F';
                    els.videoUrlStatus.style.borderLeftColor = '#D32F2F';
                    els.videoUrlStatus.style.backgroundColor = '#f8d7da';
                }


                if (!videoUrl) {
                    const errorMsg = 'No se pudo descargar el video de Instagram.\n\n' + 
                        (lastError ? 'Error: ' + lastError : 'Error desconocido');
                    throw new Error(errorMsg + '\n\nüí° Intenta:\n1. Verificar que la URL sea correcta\n2. Que el reel/post sea p√∫blico\n3. O descarga el video manualmente y s√∫belo abajo');
                }

                // Descargar el video
                els.videoUrlStatus.textContent = '‚è≥ Descargando video...';
                els.videoUrlStatus.style.color = '#0A246A';
                els.videoUrlStatus.style.borderLeftColor = '#0A246A';
                els.videoUrlStatus.style.backgroundColor = '#e3f2fd';
                els.status.textContent = '‚è≥ Descargando video...';
                els.status.className = 'status info';
                
                let response;
                let downloadError = null;
                
                try {
                    response = await fetch(videoUrl, {
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        downloadError = `Error HTTP ${response.status}`;
                        throw new Error(`Error al descargar: ${response.status} ${response.statusText}`);
                    }
                } catch (corsError) {
                    // Si falla por CORS, usar proxy CORS
                    els.videoUrlStatus.textContent = '‚è≥ Descargando con proxy CORS...';
                    els.videoUrlStatus.style.color = '#0A246A';
                    els.videoUrlStatus.style.borderLeftColor = '#0A246A';
                    els.videoUrlStatus.style.backgroundColor = '#e3f2fd';
                    els.status.textContent = '‚è≥ Descargando con proxy CORS...';
                    els.videoUrlStatus.style.color = '#666';
                    
                    try {
                        const corsProxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(videoUrl)}`;
                        response = await fetch(corsProxy);
                        
                        if (!response.ok) {
                            downloadError = `Error con proxy CORS: ${response.status}`;
                            throw new Error(`Error al descargar con proxy: ${response.status}`);
                        }
                    } catch (proxyError) {
                        downloadError = `Error con proxy: ${proxyError.message}`;
                        throw new Error(`No se pudo descargar el video. ${downloadError}`);
                    }
                }
                
                els.videoUrlStatus.textContent = '‚è≥ Procesando video descargado...';
                els.videoUrlStatus.style.color = '#0A246A';
                els.videoUrlStatus.style.borderLeftColor = '#0A246A';
                els.videoUrlStatus.style.backgroundColor = '#e3f2fd';
                els.status.textContent = '‚è≥ Procesando video descargado...';
                els.status.className = 'status info';
                
                const blob = await response.blob();
                
                if (!blob || blob.size === 0) {
                    throw new Error('El video descargado est√° vac√≠o');
                }
                
                videoFile = new File([blob], `instagram-${shortcode}.mp4`, { type: 'video/mp4' });
                
                // Mostrar preview con primer frame
                showVideoPreview(videoFile);
                els.processBtn.disabled = false;
                els.downloadOriginalBtn.disabled = false;
                
                els.videoUrlStatus.textContent = '‚úÖ Video descargado y listo (' + (blob.size / 1024 / 1024).toFixed(2) + ' MB)';
                els.videoUrlStatus.style.color = '#28a745';
                els.videoUrlStatus.style.borderLeftColor = '#28a745';
                els.videoUrlStatus.style.backgroundColor = '#d4edda';
                els.status.textContent = '‚úÖ Video descargado y listo (' + (blob.size / 1024 / 1024).toFixed(2) + ' MB)';
                els.status.className = 'status success';
                
                // NO inicializar FFmpeg aqu√≠
                // await initFFmpeg();
                
                // Auto-generar t√≠tulo y texto si hay descripci√≥n
                await autoGenerateContent();
            } catch (error) {
                console.error('Error descargando video:', error);
                
                // Mostrar error detallado
                let errorMessage = error.message;
                if (errorMessage.length > 200) {
                    errorMessage = errorMessage.substring(0, 200) + '...';
                }
                
                els.videoUrlStatus.textContent = '‚ùå Error: ' + errorMessage;
                els.videoUrlStatus.style.color = '#D32F2F';
                els.videoUrlStatus.style.borderLeftColor = '#D32F2F';
                els.videoUrlStatus.style.backgroundColor = '#f8d7da';
                
                // Mostrar tambi√©n en el status principal
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Error descargando video: ' + error.message.split('\n')[0];
                
                console.log('Error completo:', error);
            } finally {
                els.fetchVideoBtn.disabled = false;
                els.loader.style.display = 'none';
            }
            });
        } else {
            console.error('‚ùå No se pudo agregar el evento al bot√≥n fetch-video-btn');
        }

        // Cargar video desde input
        if (els.videoInput) {
            els.videoInput.addEventListener('change', async (e) => {
                console.log('üìÅ Archivo seleccionado');
                const file = e.target.files[0];
                if (!file) {
                    console.log('‚ùå No se seleccion√≥ ning√∫n archivo');
                    return;
                }
                
                console.log('üìÅ Archivo:', file.name, 'Tipo:', file.type, 'Tama√±o:', (file.size / 1024 / 1024).toFixed(2), 'MB');
                
                videoFile = file;
                
                // Mostrar mensaje de carga
                els.videoUrlStatus.textContent = '‚è≥ Cargando video...';
                els.videoUrlStatus.style.color = '#0A246A';
                els.videoUrlStatus.style.borderLeftColor = '#0A246A';
                els.videoUrlStatus.style.backgroundColor = '#e3f2fd';
                
                try {
                    showVideoPreview(file);
                    els.processBtn.disabled = false;
                    els.downloadOriginalBtn.disabled = false;
                    
                    els.status.style.display = 'block';
                    els.status.className = 'status success';
                    els.status.textContent = '‚úÖ Video cargado: ' + file.name;
                    
                    els.videoUrlStatus.textContent = '‚úÖ Video cargado: ' + file.name;
                    els.videoUrlStatus.style.color = '#28a745';
                    els.videoUrlStatus.style.borderLeftColor = '#28a745';
                    els.videoUrlStatus.style.backgroundColor = '#d4edda';
                    
                    // NO inicializar FFmpeg aqu√≠
                    // await initFFmpeg();
                    
                    // Solo auto-generar si hay descripci√≥n escrita manualmente
                    // (cuando suben archivo local, probablemente quieren escribir su propia descripci√≥n)
                    // await autoGenerateContent(); // Comentado para archivos locales
                } catch (error) {
                    console.error('‚ùå Error cargando video:', error);
                    els.videoUrlStatus.textContent = '‚ùå Error: ' + error.message;
                    els.videoUrlStatus.style.color = '#D32F2F';
                    els.videoUrlStatus.style.borderLeftColor = '#D32F2F';
                    els.videoUrlStatus.style.backgroundColor = '#f8d7da';
                }
            });
        } else {
            console.error('‚ùå No se pudo agregar el evento al input video-input');
        }

        // Actualizar preview cuando cambia el t√≠tulo
        els.titleInput.addEventListener('input', async () => {
            updateCoverPreview();
        });

        // Actualizar preview cuando cambia el frame seleccionado
        if (els.frameSelector) {
            els.frameSelector.addEventListener('input', async (e) => {
                const time = parseFloat(e.target.value);
                if (els.frameTime) els.frameTime.textContent = time.toFixed(1) + 's';
                updateCoverPreview();
            });
        }

        // Event listeners para controles de imagen
        if (els.imageXPosition) {
            els.imageXPosition.addEventListener('input', (e) => {
                els.imageXValue.textContent = e.target.value + '%';
                updateCoverPreview();
            });
        }
        
        if (els.imageYPosition) {
            els.imageYPosition.addEventListener('input', (e) => {
                els.imageYValue.textContent = e.target.value + '%';
                updateCoverPreview();
            });
        }
        
        if (els.imageZoom) {
            els.imageZoom.addEventListener('input', (e) => {
                els.imageZoomValue.textContent = e.target.value + '%';
                updateCoverPreview();
            });
        }
        
        if (els.imageEffect) {
            els.imageEffect.addEventListener('change', () => {
                updateCoverPreview();
            });
        }

        // Funci√≥n para actualizar el preview de la portada
        async function updateCoverPreview() {
            // Solo actualizar si hay un video cargado
            if (!videoFile || !els.videoThumbnail) return;
            
            try {
                const videoUrl = URL.createObjectURL(videoFile);
                const tempVideo = document.createElement('video');
                tempVideo.src = videoUrl;
                tempVideo.muted = true;
                tempVideo.preload = 'metadata';
                
                tempVideo.onloadedmetadata = () => {
                    const selectedTime = els.frameSelector ? parseFloat(els.frameSelector.value) : 0.5;
                    tempVideo.currentTime = selectedTime;
                };
                
                tempVideo.onseeked = async () => {
                    const coverCanvas = await createCoverFrame(tempVideo);
                    els.videoThumbnail.src = coverCanvas.toDataURL();
                    URL.revokeObjectURL(videoUrl);
                };
            } catch (error) {
                console.error('Error actualizando preview:', error);
            }
        }

        // Funci√≥n para auto-generar t√≠tulo y texto si hay descripci√≥n
        async function autoGenerateContent() {
            const videoDescription = els.videoDescriptionInput.value.trim();
            
            // Si no hay descripci√≥n, no hacer nada
            if (!videoDescription) {
                console.log('‚ÑπÔ∏è No hay descripci√≥n del video, saltando auto-generaci√≥n');
                return;
            }
            
            console.log('ü§ñ Auto-generando t√≠tulo y texto...');
            
            // Mostrar mensaje de que est√° generando
            els.status.style.display = 'block';
            els.status.className = 'status info';
            els.status.textContent = '‚è≥ Generando t√≠tulo y texto autom√°ticamente...';
            
            try {
                // Generar T√çTULO Y TEXTO con Gemini basado en la descripci√≥n
                const prompt = `Act√∫a como creador de contenido para redes sociales. Genera T√çTULO y COPY para Instagram sobre este video:

Descripci√≥n del video: ${videoDescription}

FORMATO ESTRICTO (muy importante):
T√çTULO: [t√≠tulo corto y llamativo en may√∫sculas, m√°ximo 5 palabras]
TEXTO: [copy MUY BREVE para Instagram, m√°ximo 300 caracteres con emojis y gancho]

IMPORTANTE: 
- El contenido es para audiencia hispanohablante internacional (NO mencionar ubicaciones espec√≠ficas)
- El T√çTULO debe ser corto, impactante, en may√∫sculas (m√°x 5 palabras)
- El TEXTO debe ser MUY BREVE, directo al grano, con emojis, estilo viral para Instagram
- M√°ximo 2-3 l√≠neas de texto antes de los hashtags
- El tono debe ser entretenido, directo y con gancho
- Al final del texto, agrega EXACTAMENTE 5 hashtags relevantes generales
- NO saludes. NO digas "Aqu√≠ tienes". Empieza directo con "T√çTULO:"
- Respeta EXACTAMENTE el formato: primero "T√çTULO:" y despu√©s "TEXTO:"`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const result = await response.json();
                if (response.ok && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let generatedContent = result.candidates[0].content.parts[0].text.trim();
                    
                    // Parsear t√≠tulo y texto
                    const titleMatch = generatedContent.match(/T√çTULO:\s*(.+?)(?=TEXTO:|$)/s);
                    const textMatch = generatedContent.match(/TEXTO:\s*(.+)$/s);
                    
                    if (titleMatch && textMatch) {
                        // Extraer y limpiar t√≠tulo
                        let titulo = titleMatch[1].trim();
                        titulo = titulo.replace(/^["']|["']$/g, ''); // Quitar comillas
                        titulo = titulo.replace(/\n.*/g, ''); // Solo primera l√≠nea
                        
                        // Extraer y limpiar texto
                        let texto = textMatch[1].trim();
                        texto = texto.replace(/^["']|["']$/g, '');
                        
                        // Actualizar campos
                        els.titleInput.value = titulo;
                        els.textOutput.value = texto;
                        els.copyTextBtn.style.display = 'block';
                        
                        // Actualizar preview con el nuevo t√≠tulo
                        await updateCoverPreview();
                        
                        // Copiar texto al portapapeles
                        try {
                            await navigator.clipboard.writeText(texto);
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ T√≠tulo y texto generados autom√°ticamente. Texto copiado al portapapeles';
                        } catch (err) {
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ T√≠tulo y texto generados autom√°ticamente';
                        }
                        
                        // Mostrar bot√≥n de regenerar
                        els.regenerateTextBtn.style.display = 'block';
                        
                        console.log('‚úÖ Auto-generaci√≥n completada');
                    } else {
                        // Si no viene en formato, intentar usar todo como texto
                        els.textOutput.value = generatedContent;
                        els.status.className = 'status success';
                        els.status.textContent = '‚úÖ Texto generado (t√≠tulo no detectado)';
                        console.log('‚ö†Ô∏è No se pudo parsear t√≠tulo del contenido generado');
                    }
                } else {
                    throw new Error(result.error?.message || 'Error generando contenido');
                }
            } catch (error) {
                console.error('‚ùå Error en auto-generaci√≥n:', error);
                const msg = (error.message || '').toLowerCase();
                if (msg.includes('quota') || msg.includes('exceeded')) {
                    els.status.className = 'status error';
                    els.status.textContent = '‚ö†Ô∏è L√≠mite de Gemini. En ~1 min toc√° "Generar T√≠tulo y Texto" o escrib√≠ a mano.';
                }
            }
        }

        // Generar texto con IA desde prompt simple (bot√≥n manual)
        els.generateTextBtn.addEventListener('click', async () => {
            const videoDescription = els.videoDescriptionInput.value.trim();
            if (!videoDescription) {
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Por favor, describe el video';
                return;
            }

            els.generateTextBtn.disabled = true;
            els.status.style.display = 'block';
            els.status.className = 'status info';
            els.status.textContent = '‚è≥ Generando texto con IA...';

            try {
                // Generar T√çTULO Y TEXTO con Gemini basado en la descripci√≥n
                const prompt = `Act√∫a como creador de contenido para redes sociales. Genera T√çTULO y COPY para Instagram sobre este video:

Descripci√≥n del video: ${videoDescription}

FORMATO ESTRICTO (muy importante):
T√çTULO: [t√≠tulo corto y llamativo en may√∫sculas, m√°ximo 5 palabras]
TEXTO: [copy MUY BREVE para Instagram, m√°ximo 300 caracteres con emojis y gancho]

IMPORTANTE: 
- El contenido es para audiencia hispanohablante internacional (NO mencionar ubicaciones espec√≠ficas)
- El T√çTULO debe ser corto, impactante, en may√∫sculas (m√°x 5 palabras)
- El TEXTO debe ser MUY BREVE, directo al grano, con emojis, estilo viral para Instagram
- M√°ximo 2-3 l√≠neas de texto antes de los hashtags
- El tono debe ser entretenido, directo y con gancho
- Al final del texto, agrega EXACTAMENTE 5 hashtags relevantes generales
- NO saludes. NO digas "Aqu√≠ tienes". Empieza directo con "T√çTULO:"
- Respeta EXACTAMENTE el formato: primero "T√çTULO:" y despu√©s "TEXTO:"`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const result = await response.json();
                if (response.ok && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let generatedContent = result.candidates[0].content.parts[0].text.trim();
                    
                    // Parsear t√≠tulo y texto
                    const titleMatch = generatedContent.match(/T√çTULO:\s*(.+?)(?=TEXTO:|$)/s);
                    const textMatch = generatedContent.match(/TEXTO:\s*(.+)$/s);
                    
                    if (titleMatch && textMatch) {
                        // Extraer y limpiar t√≠tulo
                        let titulo = titleMatch[1].trim();
                        titulo = titulo.replace(/^["']|["']$/g, ''); // Quitar comillas
                        titulo = titulo.replace(/\n.*/g, ''); // Solo primera l√≠nea
                        
                        // Extraer y limpiar texto
                        let texto = textMatch[1].trim();
                        texto = texto.replace(/^["']|["']$/g, '');
                        
                        // Actualizar campos
                        els.titleInput.value = titulo;
                        els.textOutput.value = texto;
                        els.copyTextBtn.style.display = 'block';
                        
                        // Actualizar preview con el nuevo t√≠tulo
                        await updateCoverPreview();
                        
                        // Copiar texto al portapapeles
                        try {
                            await navigator.clipboard.writeText(texto);
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ T√≠tulo y texto generados. Texto copiado al portapapeles';
                        } catch (err) {
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ T√≠tulo y texto generados';
                        }
                        
                        // Mostrar bot√≥n de regenerar
                        els.regenerateTextBtn.style.display = 'block';
                    } else {
                        // Si no viene en formato, intentar usar todo como texto
                        els.textOutput.value = generatedContent;
                        els.status.className = 'status success';
                        els.status.textContent = '‚úÖ Texto generado (t√≠tulo no detectado, ingresalo manualmente)';
                        els.regenerateTextBtn.style.display = 'block';
                    }
                } else {
                    throw new Error(result.error?.message || 'Error generando contenido');
                }
            } catch (error) {
                const msg = (error.message || '').toLowerCase();
                const isQuota = msg.includes('quota') || msg.includes('exceeded') || msg.includes('retry in');
                if (isQuota && GROQ_API_KEY) {
                    els.status.textContent = '‚è≥ Gemini al l√≠mite, probando con Groq...';
                    try {
                        const prompt = `Act√∫a como creador de contenido para redes. Genera T√çTULO y COPY para Instagram.
Descripci√≥n del video: ${videoDescription}
FORMATO ESTRICTO: T√çTULO: [corto, may√∫sculas, m√°x 5 palabras] luego TEXTO: [copy breve, m√°x 300 caracteres, emojis, 5 hashtags al final]. Responde solo con "T√çTULO:" y "TEXTO:" sin saludos.`;
                        const groqRes = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + GROQ_API_KEY },
                            body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: prompt }], max_tokens: 400 })
                        });
                        const groqJson = await groqRes.json();
                        if (groqRes.ok && groqJson.choices?.[0]?.message?.content) {
                            let generatedContent = groqJson.choices[0].message.content.trim();
                            const titleMatch = generatedContent.match(/T√çTULO:\s*(.+?)(?=TEXTO:|$)/s);
                            const textMatch = generatedContent.match(/TEXTO:\s*(.+)$/s);
                            if (titleMatch && textMatch) {
                                els.titleInput.value = titleMatch[1].trim().replace(/^["']|["']$/g, '').replace(/\n.*/g, '');
                                els.textOutput.value = textMatch[1].trim().replace(/^["']|["']$/g, '');
                                els.regenerateTextBtn.style.display = 'block';
                                els.status.className = 'status success';
                                els.status.textContent = '‚úÖ Generado con Groq (Gemini al l√≠mite)';
                            } else { throw new Error('Formato Groq'); }
                        } else { throw new Error(groqJson.error?.message || 'Groq error'); }
                    } catch (groqErr) {
                        els.status.className = 'status error';
                        els.status.textContent = '‚ùå L√≠mite de Gemini. Esper√° ~1 minuto y toc√° Regenerar, o escrib√≠ el t√≠tulo y texto a mano.';
                    }
                } else if (isQuota) {
                    els.status.className = 'status error';
                    els.status.textContent = '‚ùå L√≠mite de Gemini por ahora. Esper√° ~1 minuto y toc√° Regenerar, o escrib√≠ el t√≠tulo y texto a mano.';
                } else {
                    els.status.className = 'status error';
                    els.status.textContent = '‚ùå Error: ' + error.message;
                }
            } finally {
                els.generateTextBtn.disabled = false;
            }
        });

        // Bot√≥n de regenerar (hace lo mismo que generar)
        els.regenerateTextBtn.addEventListener('click', async () => {
            els.generateTextBtn.click(); // Simplemente ejecuta el mismo c√≥digo
        });

        // Copiar texto al portapapeles
        els.copyTextBtn.addEventListener('click', async () => {
            const text = els.textOutput.value;
            if (!text) {
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå No hay texto para copiar';
                return;
            }
            
            try {
                await navigator.clipboard.writeText(text);
                els.copyTextBtn.textContent = '‚úì Copiado';
                els.copyTextBtn.style.backgroundColor = '#28a745';
                
                els.status.style.display = 'block';
                els.status.className = 'status success';
                els.status.textContent = '‚úÖ Texto copiado al portapapeles';
                
                setTimeout(() => {
                    els.copyTextBtn.textContent = 'Copiar Texto';
                    els.copyTextBtn.style.backgroundColor = '#6c757d';
                }, 2000);
            } catch (err) {
                console.error('Error copiando:', err);
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå No se pudo copiar. Intenta manualmente.';
            }
        });

        // Descargar video original (sin procesar)
        els.downloadOriginalBtn.addEventListener('click', async () => {
            if (!videoFile) {
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå No hay video cargado';
                return;
            }
            
            try {
                const url = URL.createObjectURL(videoFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = `instagram-original-${Date.now()}.mp4`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                els.status.style.display = 'block';
                els.status.className = 'status success';
                els.status.textContent = '‚úÖ Video original descargado';
                
                setTimeout(() => {
                    els.status.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error descargando video original:', error);
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Error al descargar: ' + error.message;
            }
        });

        // Procesar video
        els.processBtn.addEventListener('click', async () => {
            if (!videoFile) {
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Por favor, sube un video primero';
                return;
            }

            els.processBtn.disabled = true;
            els.loader.style.display = 'block';
            els.progressBar.style.display = 'block';
            els.status.style.display = 'block';
            els.status.className = 'status info';
            els.status.textContent = '‚è≥ Procesando video...';

            try {
                await processVideo();
            } catch (error) {
                console.error('Error procesando video:', error);
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Error: ' + error.message;
                els.processBtn.disabled = false;
            } finally {
                els.loader.style.display = 'none';
                els.progressBar.style.display = 'none';
            }
        });

        async function processVideo() {
            // PROCESAR EN EL SERVIDOR (funciona en CUALQUIER dispositivo, incluido celular)
            
            try {
                // 1. Crear portada
                els.status.textContent = '‚è≥ Creando portada...';
                const tempVideo = document.createElement('video');
                tempVideo.src = URL.createObjectURL(videoFile);
                tempVideo.muted = true;
                await new Promise(resolve => {
                    tempVideo.onloadedmetadata = () => {
                        tempVideo.currentTime = 0;
                        resolve();
                    };
                });

                const selectedTime = els.frameSelector ? parseFloat(els.frameSelector.value) : 0.5;
                await new Promise(resolve => {
                    tempVideo.onseeked = resolve;
                    tempVideo.currentTime = selectedTime;
                });
                
                const coverCanvas = await createCoverFrame(tempVideo);
                const coverImageData = coverCanvas.toDataURL('image/png');
                
                // Logo SN igual que en la placa (para marca de agua en el video)
                const watermarkCanvas = createWatermark();
                const watermarkImageData = watermarkCanvas.toDataURL('image/png');
                
                // 2. Convertir video a base64
                els.status.textContent = '‚è≥ Preparando video...';
                const videoBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(videoFile);
                });
                
                // 3. Enviar al servidor para procesar
                els.status.textContent = '‚è≥ Procesando en el servidor...';
                
                const apiBase = getApiBase();
                const hostname = window.location.hostname;
                const port = window.location.port;
                const isLocal = !apiBase && (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.') || port === '8000');
                const apiUrl = apiBase ? `${apiBase}/api/process-video` : (isLocal ? `http://${hostname}:8000/api/process-video` : '/api/process-video');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_data: videoBase64,
                        cover_image: coverImageData,
                        watermark_image: watermarkImageData,
                        title: els.titleInput.value
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error del servidor');
                }
                
                const result = await response.json();
                
                // 4. Convertir resultado a blob
                els.status.textContent = '‚è≥ Finalizando...';
                const outputBytes = atob(result.video_data);
                const outputArray = new Uint8Array(outputBytes.length);
                for (let i = 0; i < outputBytes.length; i++) {
                    outputArray[i] = outputBytes.charCodeAt(i);
                }
                processedVideoBlob = new Blob([outputArray], { type: 'video/mp4' });
                
                // 5. Mostrar preview
                showVideoPreview(processedVideoBlob);
                els.downloadBtn.disabled = false;
                els.downloadBtn.style.display = 'block';
                els.processBtn.disabled = false;
                
                // 6. Copiar texto al portapapeles ANTES de compartir
                const texto = els.textOutput.value;
                if (texto) {
                    try {
                        await navigator.clipboard.writeText(texto);
                        console.log('‚úÖ Texto copiado autom√°ticamente al portapapeles');
                    } catch (err) {
                        console.log('‚ö†Ô∏è No se pudo copiar al portapapeles:', err);
                    }
                }
                
                els.status.className = 'status success';
                els.status.textContent = '‚úÖ Video procesado. Texto copiado. Abriendo Instagram...';
                
                // 7. Compartir autom√°ticamente (con texto ya copiado)
                // Dar tiempo para que el blob est√© listo
                setTimeout(async () => {
                    try {
                        await shareToInstagram();
                    } catch (error) {
                        console.error('Error en shareToInstagram:', error);
                        els.status.className = 'status error';
                        els.status.textContent = '‚ùå Error compartiendo: ' + error.message;
                    }
                }, 1000);
                
                URL.revokeObjectURL(tempVideo.src);
                
            } catch (error) {
                console.error('Error procesando video:', error);
                throw error;
            }
        }

        // Mismo logo que en la portada: SN 120px + saltanews.com.ar, misma posici√≥n visual
        function createWatermark() {
            const canvas = document.createElement('canvas');
            canvas.width = 260;
            canvas.height = 170;
            const ctx = canvas.getContext('2d');
            // Mismo bloque que la portada: SN 120px + texto abajo (centro 130, SN en y=60, url en y=114)
            const centerX = canvas.width / 2;
            ctx.font = `italic 900 120px 'Montserrat'`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const wS = ctx.measureText('S').width;
            const wN = ctx.measureText('N').width;
            const gap = 120 * 0.15;
            const totW = wS - gap + wN;
            let curX = centerX - totW / 2;
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.fillStyle = '#b42727';
            ctx.fillText('S', curX + wS/2, 60);
            curX += wS - gap;
            ctx.fillStyle = '#2a2972';
            ctx.fillText('N', curX + wN/2, 60);
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.font = `italic 700 ${120 * 0.14}px 'Montserrat'`;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText('saltanews.com.ar', centerX, 60 + 120 * 0.45);
            return canvas;
        }

        async function createCoverFrame(videoElement) {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920; // 9:16 formato vertical
            const ctx = canvas.getContext('2d');

            // PORTADA ESTILO PLACA AZUL (exacto como gensn.html)
            const h = 1920 * 0.55; // 55% para imagen, 45% para texto
            const SIDEBAR_OFFSET = 40;
            const SIDEBAR_WIDTH = 20; // Barra roja delgada (20px, no 80!)

            // Fondo azul en la parte inferior
            ctx.fillStyle = '#0A246A';
            ctx.fillRect(0, h, 1080, 1920 - h);

            // Dibujar frame del video en la parte superior
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = videoElement.videoWidth || 1080;
            tempCanvas.height = videoElement.videoHeight || 1920;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(videoElement, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const frameImg = await new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = tempCanvas.toDataURL();
            });

            // Obtener valores de los controles
            const zoom = els.imageZoom ? parseFloat(els.imageZoom.value) / 100 : 1;
            const xOffset = els.imageXPosition ? parseFloat(els.imageXPosition.value) : 0;
            const yOffset = els.imageYPosition ? parseFloat(els.imageYPosition.value) : 0;
            const bgMode = els.imageEffect ? els.imageEffect.value : 'cover';
            
            const imgRatio = frameImg.width / frameImg.height;
            const areaRatio = 1080 / h;
            
            // Guardar contexto y crear clip para el √°rea de imagen
            ctx.save();
            ctx.beginPath();
            ctx.rect(0, 0, 1080, h); // Solo el √°rea superior
            ctx.clip();
            
            // 1. DIBUJAR FONDO (si no es cover)
            if (bgMode === 'gradient') {
                // Degradado rojo ‚Üí azul horizontal
                const gradient = ctx.createLinearGradient(0, 0, 1080, 0);
                gradient.addColorStop(0, '#D32F2F'); // Rojo
                gradient.addColorStop(1, '#0A246A'); // Azul
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, h);
            } else if (bgMode === 'blur') {
                // Imagen desenfocada de fondo
                ctx.filter = 'blur(20px) brightness(0.7)';
                
                let sw, sh, sx, sy;
                if (imgRatio > areaRatio) {
                    sh = frameImg.height;
                    sw = frameImg.height * areaRatio;
                    sx = (frameImg.width - sw) / 2;
                    sy = 0;
                } else {
                    sw = frameImg.width;
                    sh = frameImg.width / areaRatio;
                    sy = (frameImg.height - sh) / 2;
                    sx = 0;
                }
                ctx.drawImage(frameImg, sx, sy, sw, sh, 0, 0, 1080, h);
                ctx.filter = 'none';
            }
            
            // 2. DIBUJAR IMAGEN (SIEMPRE IGUAL, independiente del modo)
            let sw, sh, sx, sy;
            
            if (imgRatio > areaRatio) {
                sh = frameImg.height;
                sw = frameImg.height * areaRatio;
                sx = (frameImg.width - sw) / 2;
                sy = 0;
            } else {
                sw = frameImg.width;
                sh = frameImg.width / areaRatio;
                sy = (frameImg.height - sh) / 2;
                sx = 0;
            }
            
            // Aplicar zoom al crop
            const zoomFactor = 1 / zoom;
            const newSw = sw * zoomFactor;
            const newSh = sh * zoomFactor;
            sx += (sw - newSw) / 2;
            sy += (sh - newSh) / 2;
            sw = newSw;
            sh = newSh;
            
            // Aplicar offsets
            sx += (xOffset / 100) * frameImg.width * 0.5;
            sy += (yOffset / 100) * frameImg.height * 0.5;
            
            // Dibujar la imagen siempre igual
            ctx.drawImage(frameImg, sx, sy, sw, sh, 0, 0, 1080, h);
            
            // Restaurar contexto (quitar clip)
            ctx.restore();

            // L√≠nea separadora azul
            ctx.fillStyle = '#0A246A';
            ctx.fillRect(0, h - 15, 1080, 16);

            // Barra roja lateral IZQUIERDA (importante!)
            ctx.fillStyle = '#D32F2F';
            ctx.fillRect(SIDEBAR_OFFSET, h, SIDEBAR_WIDTH, 1920 - h);

            // Logo SN arriba a la derecha en blanco
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = `italic 900 120px 'Montserrat'`;
            const wS = ctx.measureText('S').width;
            const wN = ctx.measureText('N').width;
            const gap = 120 * 0.15;
            const totW = wS - gap + wN;
            let curX = 1080 - 150 - totW / 2;
            
            // Sombra para el logo
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillStyle = '#b42727';
            ctx.fillText('S', curX + wS/2, 100);
            curX += wS - gap;
            ctx.fillStyle = '#2a2972';
            ctx.fillText('N', curX + wN/2, 100);
            
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            
            ctx.font = `italic 700 ${120 * 0.14}px 'Montserrat'`;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText('saltanews.com.ar', 1080 - 150, 100 + 120 * 0.45);
            ctx.restore();

            // T√≠tulo en la secci√≥n azul inferior (a la derecha de la barra roja)
            const title = els.titleInput.value.trim();
            if (title) {
                ctx.fillStyle = '#FFFFFF';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                
                // Valores exactos de gensn.html
                const tx = SIDEBAR_OFFSET + SIDEBAR_WIDTH + 40; // 40 + 20 + 40 = 100px
                const maxW = 1080 - tx * 2; // 1080 - 200 = 880px (igual que gensn)
                const maxH = 1920 - h - 40; // Altura disponible para el texto
                let fontSize = 90; // Tama√±o inicial (igual que gensn)
                
                // Algoritmo exacto de gensn.html para ajustar tama√±o
                const titleUpper = title.toUpperCase();
                while (fontSize > 24) {
                    ctx.font = `${fontSize}px "Archivo Black"`;
                    const textHeight = getTextHeightCanvas(ctx, titleUpper, fontSize, maxW);
                    if (textHeight <= maxH) break;
                    fontSize -= 2; // Reducir de a 2px (igual que gensn)
                }
                
                // Calcular altura total del texto
                const textHeight = getTextHeightCanvas(ctx, titleUpper, fontSize, maxW);
                const lineHeight = fontSize * 1.2;
                
                // Centrar verticalmente
                let y = h + 40 + (maxH - textHeight) / 2;
                
                // Dibujar texto con wrapText
                ctx.font = `${fontSize}px "Archivo Black"`;
                wrapTextCanvas(ctx, titleUpper, tx, y, maxW, lineHeight);
            }

            return canvas;
        }

        // Funciones helper exactas de gensn.html
        function getTextHeightCanvas(ctx, txt, size, maxW) {
            ctx.font = `${size}px "Archivo Black"`;
            const lh = size * 1.2;
            let h = 0;
            let line = '';
            txt.split(' ').forEach(w => {
                const test = line + (line ? ' ' : '') + w;
                if (ctx.measureText(test).width > maxW) {
                    h += lh;
                    line = w;
                } else {
                    line = test;
                }
            });
            return h + (line ? lh : 0);
        }

        function wrapTextCanvas(ctx, txt, x, y, maxW, lh) {
            let line = '';
            txt.split(' ').forEach(w => {
                const test = line + (line ? ' ' : '') + w;
                if (ctx.measureText(test).width > maxW) {
                    ctx.fillText(line, x, y);
                    y += lh;
                    line = w;
                } else {
                    line = test;
                }
            });
            if (line) ctx.fillText(line, x, y);
        }
        
        // Funci√≥n legacy para compatibilidad
        // Funciones helper exactas de gensn.html
        function getTextHeightCanvas(ctx, txt, size, maxW) {
            ctx.font = `${size}px "Archivo Black"`;
            const lh = size * 1.2;
            let h = 0;
            let line = '';
            txt.split(' ').forEach(w => {
                const test = line + (line ? ' ' : '') + w;
                if (ctx.measureText(test).width > maxW) {
                    h += lh;
                    line = w;
                } else {
                    line = test;
                }
            });
            return h + (line ? lh : 0);
        }

        function wrapTextCanvas(ctx, txt, x, y, maxW, lh) {
            let line = '';
            txt.split(' ').forEach(w => {
                const test = line + (line ? ' ' : '') + w;
                if (ctx.measureText(test).width > maxW) {
                    ctx.fillText(line, x, y);
                    y += lh;
                    line = w;
                } else {
                    line = test;
                }
            });
            if (line) ctx.fillText(line, x, y);
        }
        
        function wrapText(ctx, text, maxWidth, fontSize) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        // Compartir en Instagram autom√°ticamente
        async function shareToInstagram() {
            console.log('üîÑ Iniciando shareToInstagram...');
            console.log('processedVideoBlob:', processedVideoBlob ? 'existe' : 'no existe');
            
            if (!processedVideoBlob) {
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå No hay video procesado para compartir';
                return;
            }
            
            try {
                const text = els.textOutput.value || '';
                const title = els.titleInput.value || 'Video SN';
                
                console.log('üìù Texto a copiar:', text.substring(0, 50) + '...');
                
                // Asegurar que el texto est√© copiado PRIMERO
                if (text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        console.log('‚úÖ Texto copiado al portapapeles');
                        els.status.textContent = '‚úÖ Texto copiado. Abriendo Instagram...';
                    } catch (err) {
                        console.error('‚ö†Ô∏è Error copiando texto:', err);
                        // Continuar aunque falle la copia
                    }
                }
                
                // Verificar si el navegador soporta Web Share API
                console.log('navigator.share:', !!navigator.share);
                console.log('navigator.canShare:', !!navigator.canShare);
                
                if (navigator.share) {
                    const videoFile = new File([processedVideoBlob], `sn-video-${Date.now()}.mp4`, { type: 'video/mp4' });
                    console.log('üìÅ Archivo creado:', videoFile.name, videoFile.size, 'bytes');
                    
                    const shareData = {
                        files: [videoFile],
                        title: title,
                        text: text
                    };
                    
                    // Verificar si puede compartir con archivos
                    if (navigator.canShare && navigator.canShare(shareData)) {
                        console.log('‚úÖ Puede compartir archivos');
                        els.status.style.display = 'block';
                        els.status.className = 'status info';
                        els.status.textContent = 'üì± Abriendo opciones para compartir...';
                        
                        try {
                            await navigator.share(shareData);
                            console.log('‚úÖ Compartido exitosamente');
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ Video compartido. Texto copiado.';
                        } catch (shareError) {
                            console.error('Error en navigator.share:', shareError);
                            if (shareError.name === 'AbortError') {
                                els.status.className = 'status info';
                                els.status.textContent = '‚ÑπÔ∏è Compartir cancelado. Texto copiado.';
                            } else {
                                // Si falla compartir, descargar
                                throw shareError;
                            }
                        }
                    } else {
                        console.log('‚ö†Ô∏è No puede compartir archivos, intentando solo texto...');
                        // Intentar compartir solo texto
                        try {
                            await navigator.share({
                                title: title,
                                text: text,
                                url: window.location.href
                            });
                            // Si comparti√≥ texto, descargar video
                            const url = URL.createObjectURL(processedVideoBlob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sn-video-${Date.now()}.mp4`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ Texto compartido. Video descargado.';
                        } catch (err) {
                            console.log('‚ö†Ô∏è No se pudo compartir texto, descargando video...');
                            // Fallback: descargar autom√°ticamente
                            const url = URL.createObjectURL(processedVideoBlob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sn-video-${Date.now()}.mp4`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            els.status.className = 'status success';
                            els.status.textContent = '‚úÖ Video descargado. Texto copiado. Abr√≠ Instagram y subilo.';
                        }
                    }
                } else {
                    console.log('‚ö†Ô∏è Navigator.share no disponible, descargando...');
                    // Navegador no soporta Web Share API - descargar
                    const url = URL.createObjectURL(processedVideoBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sn-video-${Date.now()}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    els.status.className = 'status success';
                    els.status.textContent = '‚úÖ Video descargado. Texto copiado. Abr√≠ Instagram y subilo.';
                }
            } catch (error) {
                console.error('‚ùå Error compartiendo:', error);
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Error: ' + error.message;
            }
        }

        // Descargar video
        els.downloadBtn.addEventListener('click', async () => {
            if (!processedVideoBlob) {
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå No hay video procesado para descargar';
                return;
            }
            
            try {
                els.downloadBtn.disabled = true;
                els.downloadBtn.textContent = '‚è≥ Descargando...';
                
                const url = URL.createObjectURL(processedVideoBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'video-sn-' + Date.now() + '.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Esperar un poco antes de revocar la URL
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    els.downloadBtn.disabled = false;
                    els.downloadBtn.textContent = 'Descargar Video';
                    
                    els.status.style.display = 'block';
                    els.status.className = 'status success';
                    els.status.textContent = '‚úÖ Video descargado';
                    setTimeout(() => {
                        els.status.style.display = 'none';
                    }, 3000);
                }, 100);
            } catch (error) {
                console.error('Error descargando:', error);
                els.status.style.display = 'block';
                els.status.className = 'status error';
                els.status.textContent = '‚ùå Error al descargar: ' + error.message;
                els.downloadBtn.disabled = false;
                els.downloadBtn.textContent = 'Descargar Video';
            }
        });

        // Esperar a que las fuentes est√©n cargadas
        async function waitForFonts() {
            if (document.fonts && document.fonts.ready) {
                await document.fonts.ready;
            }
        }

        // Mensaje inicial visible
        console.log('üöÄ Script cargado y ejecut√°ndose...');
        
        // Verificar si SharedArrayBuffer est√° disponible
        const hasSharedArrayBuffer = typeof SharedArrayBuffer !== 'undefined';
        console.log('SharedArrayBuffer disponible:', hasSharedArrayBuffer);
        
        if (!hasSharedArrayBuffer) {
            console.warn('‚ö†Ô∏è SharedArrayBuffer no est√° disponible. FFmpeg puede no funcionar.');
        }
        
        // Mostrar mensaje inicial en el status
        if (els.status) {
            els.status.style.display = 'block';
            els.status.className = 'status info';
            els.status.textContent = '‚è≥ Inicializando sistema...';
        }
        
        // Inicializar al cargar
        window.addEventListener('load', async () => {
            console.log('üöÄ P√°gina cargada, inicializando...');
            
            if (els.status) {
                els.status.style.display = 'block';
                els.status.className = 'status info';
                els.status.textContent = '‚è≥ Cargando procesador de video...';
            }
            
            await waitForFonts();
            console.log('‚úÖ Fuentes cargadas');
            
            // NO inicializar FFmpeg autom√°ticamente - se carga cuando se va a usar
            console.log('‚úÖ Inicializaci√≥n completa (FFmpeg se cargar√° al procesar)');
            
            if (els.status) {
                els.status.textContent = '‚úÖ Sistema listo para usar';
                setTimeout(() => {
                    els.status.style.display = 'none';
                }, 3000);
            }
        });

        // Tambi√©n ejecutar cuando el DOM est√© listo (por si acaso)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM cargado');
            });
        } else {
            console.log('üìÑ DOM ya estaba listo');
        }
    </script>
</body>
</html>
